<!DOCTYPE html>
<html>
 
<head>
    <meta charset="UTF-8">
    <title>Web Speech API</title>
    <script>
        var flag_speech = 0;
 
        var wSck= new WebSocket("ws://localhost:60000/");

        wSck.onopen = function() {
            document.getElementById('status_connection').innerHTML += "接続完了";
        };

        wSck.onmessage = function(e) {
        };

        var send_msg = function(val) {
            var line = document.getElementById('msg');
            wSck.send(line.value);
        };

        function start_sr() {
            window.SpeechRecognition = window.SpeechRecognition || webkitSpeechRecognition;
            var recognition = new webkitSpeechRecognition();
            recognition.lang = 'ja';
            recognition.interimResults = true;
            recognition.continuous = true;
 
            recognition.onsoundstart = function() {
                document.getElementById('status_sr').innerHTML = "認識中";
            };
            recognition.onnomatch = function() {
                document.getElementById('status_sr').innerHTML = "認識失敗";
            };
            recognition.onerror = function() {
                document.getElementById('status_sr').innerHTML = "エラー";
                if(flag_speech == 0)
                start_sr();
            };
            recognition.onsoundend = function() {
                document.getElementById('status_sr').innerHTML = "停止中";
                start_sr();
            };
 
            recognition.onresult = function(event) {
                var results = event.results;
                for (var i = event.resultIndex; i < results.length; i++) {
                    if (results[i].isFinal)
                    {
                        document.getElementById('result_text').innerHTML = results[i][0].transcript;
                        wSck.send(results[i][0].transcript);
                        start_sr();
                    }
                    else
                    {
                        document.getElementById('result_text').innerHTML = "[認識中...] " + results[i][0].transcript;
                        flag_speech = 1;
                    }
                }
            }
            flag_speech = 0;
            document.getElementById('status_sr').innerHTML = "start";
            recognition.start();
        }
    </script> 
</head>
 
<body>
    認識結果：
    <textarea id="result_text" cols="100" rows="5"></textarea>
    <br>
    認識状態：
    <textarea id="status_sr" cols="100" rows="1"></textarea>
    <br>
    接続状態：
    <textarea id="status_connection" cols="100" rows="1"></textarea>
    <input type="button" onClick="start_sr();" value="音認開始">
    <br>
    <br>
    送信テスト：
    <textarea id="msg" cols="100" rows="1"></textarea>
    <input type="button" onClick="send_msg();" value="送信">
</body>
 
</html>